{% extends "base.html" %}
{% block title %}Gestión de Vehículos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Gestión de Vehículos </h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal" id="btn-add-vehicle">
        ➕ Añadir Nuevo Vehículo
    </button>
</div>

<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>Matrícula</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Año</th>
            <th>Capacidad (kg)</th>
            <th>Piloto Asignado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for vehicle in vehicles %}
        <tr>
            <td>{{ vehicle.plate }}</td>
            <td>{{ vehicle.brand }}</td>
            <td>{{ vehicle.model }}</td>
            <td>{{ vehicle.year }}</td>
            <td>{{ vehicle.capacity_kg }}</td>
            <td>{{ vehicle.assigned_pilot_name | default('Ninguno') }}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editVehicle('{{ vehicle.plate }}', '{{ vehicle.brand }}', '{{ vehicle.model }}', '{{ vehicle.year }}', '{{ vehicle.capacity_kg }}')">Editar</button>
                
                <button class="btn btn-sm btn-info" onclick="openAssignmentModal('{{ vehicle.plate }}', '{{ vehicle.assigned_pilot_name }}')">Asignar Piloto</button>

                <form method="POST" style="display:inline;" action="{{ url_for('manage_vehicles_web') }}" onsubmit="return confirm('¿Eliminar {{ vehicle.plate }}?')">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="plate" value="{{ vehicle.plate }}">
                    <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="assignPilotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('manage_vehicles_web') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalLabel">Asignar Piloto a <span id="assign-plate-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="plate" id="assign-plate-input">
                    <input type="hidden" name="action" value="assign">

                    <div class="mb-3">
                        <label for="pilot_id" class="form-label">Seleccionar Piloto</label>
                        <select class="form-select" id="pilot_id" name="pilot_id" required>
                            <option value="">-- Seleccionar Piloto --</option>
                            {% for pilot in pilots %}
                                {% if pilot.role == 'piloto' %}
                                    <option value="{{ pilot.id }}">{{ pilot.full_name }} ({{ pilot.username }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Asignar</button>
                    <button type="submit" name="action" value="unassign" class="btn btn-warning" onclick="return confirm('¿Desasignar este vehículo?')">Desasignar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addVehicleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="vehicleForm" method="POST" action="{{ url_for('manage_vehicles_web') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Añadir Nuevo Vehículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" id="vehicleAction" value="add">
                    
                    <div class="mb-3">
                        <label for="plate" class="form-label">Matrícula</label>
                        <input type="text" class="form-control" id="plate" name="plate" required maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label for="brand" class="form-label">Marca</label>
                        <input type="text" class="form-control" id="brand" name="brand" required>
                    </div>
                    <div class="mb-3">
                        <label for="model" class="form-label">Modelo</label>
                        <input type="text" class="form-control" id="model" name="model" required>
                    </div>
                    <div class="mb-3">
                        <label for="year" class="form-label">Año</label>
                        <input type="number" class="form-control" id="year" name="year" required min="1900">
                    </div>
                    <div class="mb-3">
                        <label for="capacity_kg" class="form-label">Capacidad (kg)</label>
                        <input type="number" class="form-control" id="capacity_kg" name="capacity_kg" required min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    var addVehicleModal = new bootstrap.Modal(document.getElementById('addVehicleModal'));
    var assignPilotModal = new bootstrap.Modal(document.getElementById('assignPilotModal'));

    // 1. Lógica para el modal de Añadir/Editar
    document.getElementById('btn-add-vehicle').onclick = function() {
        // Resetear el formulario para añadir
        document.getElementById('vehicleForm').reset();
        document.getElementById('modalLabel').innerText = 'Añadir Nuevo Vehículo';
        document.getElementById('vehicleAction').value = 'add';
        document.getElementById('plate').readOnly = false;
    };

    function editVehicle(plate, brand, model, year, capacity) {
        document.getElementById('modalLabel').innerText = 'Editar Vehículo ' + plate;
        document.getElementById('vehicleAction').value = 'update';
        document.getElementById('plate').value = plate;
        document.getElementById('plate').readOnly = true; 
        document.getElementById('brand').value = brand;
        document.getElementById('model').value = model;
        document.getElementById('year').value = year;
        document.getElementById('capacity_kg').value = capacity;
        addVehicleModal.show();
    }
    
    // 2. Lógica para el modal de Asignación
    function openAssignmentModal(plate, assignedPilotName) {
        document.getElementById('assign-plate-display').innerText = plate;
        document.getElementById('assign-plate-input').value = plate;
        // La placa para el botón desasignar debe ser el vehículo actual que se está abriendo
        document.querySelector('#assignPilotModal form button[value="unassign"]').previousElementSibling.value = plate; 

        // Puedes añadir aquí lógica para preseleccionar al piloto si ya está asignado.
        
        assignPilotModal.show();
    }

</script>
{% endblock %}
