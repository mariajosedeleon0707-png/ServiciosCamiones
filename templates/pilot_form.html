{% extends "base.html" %}
{% block title %}Reporte de Inspecci贸n{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-lg">
            <div class="card-header bg-success text-white text-center">
                <h3>Reporte de Inspecci贸n 360 Vehicular - Piloto</h3>
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% elif pilot_data %}
                    <form method="POST" action="{{ url_for('pilot_form') }}">
                        <div class="mb-4 p-3 border rounded">
                            <h5 class="text-primary">Datos de la Promoci贸n y Licencia</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="promo_marca" class="form-label">Marca a promocionar:</label>
                                    <input type="text" class="form-control" id="promo_marca" name="promo_marca" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="fecha_inicio" class="form-label">Fecha inicio:</label>
                                    <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="fecha_finalizacion" class="form-label">Fecha finalizaci贸n:</label>
                                    <input type="date" class="form-control" id="fecha_finalizacion" name="fecha_finalizacion" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tipo_licencia" class="form-label">Tipo de licencia de conducir:</label>
                                    <input type="text" class="form-control" id="tipo_licencia" name="tipo_licencia" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="vencimiento_licencia" class="form-label">Vencimiento licencia:</label>
                                    <input type="date" class="form-control" id="vencimiento_licencia" name="vencimiento_licencia" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="tarjeta_seguro" class="form-label">Tarjeta seguro:</label>
                                    <input type="text" class="form-control" id="tarjeta_seguro" name="tarjeta_seguro" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 p-3 border rounded bg-light">
                            <h5 class="text-primary">Datos del Veh铆culo</h5>
                            <div class="row">
                                <div class="col-md-3"><strong>Piloto:</strong> {{ pilot_data.full_name }}</div>
                                <div class="col-md-3"><strong>Placa:</strong> {{ pilot_data.plate }}</div>
                                <div class="col-md-3"><strong>Marca:</strong> {{ pilot_data.brand }}</div>
                                <div class="col-md-3"><strong>Modelo:</strong> {{ pilot_data.model }}</div>
                            </div>
                            <hr>
                            <div class="row mt-2">
                                <div class="col-md-4 mb-3">
                                    <label for="km_actual" class="form-label">Kilometraje Actual (KM)</label>
                                    <input type="number" step="0.01" class="form-control" id="km_actual" name="km_actual" required min="1">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="km_proximo_servicio" class="form-label">Kilometraje Pr贸ximo Servicio</label>
                                    <input type="number" step="0.01" class="form-control" id="km_proximo_servicio" name="km_proximo_servicio">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fecha_servicio_anterior" class="form-label">Fecha servicio anterior</label>
                                    <input type="date" class="form-control" id="fecha_servicio_anterior" name="fecha_servicio_anterior">
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5 class="text-primary">Lista de Chequeo (Marcar: Buen estado, Mal estado o N/A)</h5>
                            <table class="table table-bordered table-sm">
                                <thead class="table-info">
                                    <tr>
                                        <th>Categor铆a</th>
                                        <th>tem a evaluar</th>
                                        <th class="text-center">Buen estado</th>
                                        <th class="text-center">Mal estado</th>
                                        <th class="text-center">N/A</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category, items in checklist %}
                                        {% for item in items %}
                                            <tr>
                                                {% if loop.first %}
                                                    {# La celda de la categor铆a abarca todas las filas de sus 铆tems #}
                                                    <td rowspan="{{ items | length }}" class="align-middle fw-bold">{{ category }}</td>
                                                {% endif %}
                                                <td>{{ item }}</td>
                                                {# Genera la clave normalizada para que coincida con la l贸gica de app.py #}
                                                {#  CORRECCIN: Se agrega | replace('.', '') para limpiar el punto y sincronizar con main.py #}
                                                {% set input_name = 'check_' + item | replace(' ', '_') | replace('/', '_') | replace('(', '') | replace(')', '') | replace(',', '') | replace('-', '') | replace('.', '') %}
                                                <td class="text-center">
                                                    <input type="radio" name="{{ input_name }}" value="Buen estado" required>
                                                </td>
                                                <td class="text-center">
                                                    <input type="radio" name="{{ input_name }}" value="Mal estado" required>
                                                </td>
                                                <td class="text-center">
                                                    <input type="radio" name="{{ input_name }}" value="N/A" required>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <div class="mb-3">
                                <label for="observations" class="form-label">Observaciones adicionales:</label>
                                <textarea class="form-control" id="observations" name="observations" rows="3"></textarea>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="confirmado" id="signature_confirmation" name="signature_confirmation" required>
                                <label class="form-check-label" for="signature_confirmation">
                                    Confirmo que he realizado la inspecci贸n 360 veh铆cular y los datos son correctos. (Firma aceptaci贸n piloto promotor)
                                </label>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">Guardar Reporte de Inspecci贸n</button>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-danger">
                        No se pudo cargar la informaci贸n del piloto o del veh铆culo.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
