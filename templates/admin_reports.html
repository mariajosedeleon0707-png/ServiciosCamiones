{% extends "base.html" %}
{% block title %}Revisi칩n de Reportes{% endblock %}

{% block content %}
<h2>Revisi칩n y Exportaci칩n de Reportes</h2>
<p class="lead">Filtre los reportes por rango de fechas, piloto o veh칤culo, y exp칩rtelos a un archivo CSV.</p>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        Filtros de B칰squeda
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin_reports') }}"> {# Endpoint correcto #}
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Desde</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ filters.start_date }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">Hasta</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ filters.end_date }}">
                </div>
                
                {# MODIFICACI칍N: Mostrar el filtro de piloto solo si el usuario es administrador #}
                {% if session.get('role') == 'admin' %}
                <div class="col-md-3">
                    <label for="pilot_id" class="form-label">Piloto</label>
                    <select class="form-select" id="pilot_id" name="pilot_id">
                        <option value="">Todos los Pilotos</option>
                        {% for pilot in pilots %}
                        <option value="{{ pilot.id }}" {% if filters.pilot_id|string == pilot.id|string %}selected{% endif %}>
                            {{ pilot.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                {% else %}
                {# Si no es admin, ajustamos el ancho de la columna de matr칤cula #}
                <div class="col-md-5">
                {% endif %}
                
                    <label for="vehicle_plate" class="form-label">Matr칤cula</label>
                    <input type="text" class="form-control" id="vehicle_plate" name="vehicle_plate" value="{{ filters.vehicle_plate }}" placeholder="Ej: C123456">
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Resultados ({{ reports | length }} reportes encontrados)</h3>
    <a href="{{ url_for('export_reports') }}?{{ request.query_string.decode() }}" class="btn btn-success">
        游 Exportar a CSV
    </a>
</div>

{% if reports %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Fecha/Hora</th>
                
                {# MODIFICACI칍N: Mostrar la columna Piloto solo si el usuario es administrador #}
                {% if session.get('role') == 'admin' %}
                <th>Piloto</th>
                {% endif %}
                
                <th>Matr칤cula</th>
                <th>KM</th>
                <th>Obs.</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td>{{ report.id }}</td>
            <td>{{ report.report_date.split(' ')[0] }}<br><small class="text-muted">{{ report.report_date.split(' ')[1] }}</small></td>
                
                {# MODIFICACI칍N: Mostrar el dato del Piloto solo si el usuario es administrador #}
                {% if session.get('role') == 'admin' %}
                <td>{{ report.pilot_name }}</td>
                {% endif %}
                
                <td>{{ report.vehicle_plate }}</td>
                <td>{{ report.km_actual | int | separator }}</td>
                <td> 
                    {% if report.observations %}
                        <span class="badge bg-warning text-dark">S칈</span>
                    {% else %}
                        <span class="badge bg-secondary">NO</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick='showReportDetail({{ report | tojson | safe }})'>Detalle</button>
                    
                    {# SEGURIDAD: Mostrar Eliminar SOLO si es administrador #}
                    {% if session.get('role') == 'admin' %}
                    <form method="POST" style="display:inline;" action="{{ url_for('delete_report_web', report_id=report.id) }}" onsubmit="return confirm('쮼st치 seguro de que desea eliminar este reporte?')">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info" role="alert">
    No se encontraron reportes con los filtros aplicados.
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detailModalLabel">Detalle del Reporte #...</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detail-body">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showReportDetail(report) {
        // 游뚿 CORRECCI칍N CR칈TICA: Se usa 'checklist_details' (lista de objetos) en lugar de 'checklist_data' (objeto simple).
        const checklist_details_list = report.checklist_details;
        
        // Verificaci칩n de datos
        if (!report || !report.header_data || !checklist_details_list) {
            console.error("Reporte no v치lido o datos incompletos.", report);
            document.getElementById('detail-body').innerHTML = '<div class="alert alert-danger">Error: Datos de reporte no encontrados o inv치lidos. Confirme la migraci칩n de la columna `checklist_data` y revise la consulta en db_manager.</div>';
            var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            detailModal.show();
            return;
        }

        const header_data = report.header_data;
        
        // Funci칩n para formatear el KM con separador de miles
        function formatKilometers(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return 'N/A';
            }
            // Usa el formato local y luego reemplaza las comas por puntos (formato com칰n en espa침ol)
            let formatted = parseFloat(value).toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            return formatted.replace(/,/g, '.') + ' KM';
        }

        let html = `
            <h6>Datos del Reporte</h6>
            <table class="table table-sm table-borderless">
                <tr><th>Reporte ID:</th><td>${report.id}</td></tr>
                <tr><th>Fecha:</th><td>${report.report_date}</td></tr>
                <tr><th>Piloto:</th><td>${report.pilot_name}</td></tr>
                <tr><th>Veh칤culo:</th><td>${report.vehicle_plate} (${header_data.brand || 'N/A'} ${header_data.model || 'N/A'})</td></tr>
                <tr><th>Kilometraje Actual:</th><td>${formatKilometers(report.km_actual)}</td></tr>
                <tr><th>Observaciones:</th><td>${report.observations || 'N/A'}</td></tr>
                <tr><th>Confirmaci칩n de Piloto:</th><td>${header_data.signature_confirmation || 'CONFIRMADO'}</td></tr>
            </table>
            
            <hr>
            <h6>Datos de Log칤stica y Servicio</h6>
            <table class="table table-sm table-borderless">
                <tr><th>Marca a Promocionar:</th><td>${header_data.promo_marca || 'N/A'}</td></tr>
                <tr><th>Fecha Inicio Campa침a:</th><td>${header_data.fecha_inicio || 'N/A'}</td></tr>
                <tr><th>Fecha Finalizaci칩n Campa침a:</th><td>${header_data.fecha_finalizacion || 'N/A'}</td></tr>
                <tr><th>Tipo de Licencia:</th><td>${header_data.tipo_licencia || 'N/A'}</td></tr>
                <tr><th>Vencimiento Licencia:</th><td>${header_data.vencimiento_licencia || 'N/A'}</td></tr>
                <tr><th>Tarjeta Seguro:</th><td>${header_data.tarjeta_seguro || 'N/A'}</td></tr>
                <tr><th>KM Pr칩ximo Servicio:</th><td>${formatKilometers(report.km_proximo_servicio || header_data.km_proximo_servicio)}</td></tr>
                <tr><th>Fecha Servicio Anterior:</th><td>${report.fecha_servicio_anterior || header_data.fecha_servicio_anterior || 'N/A'}</td></tr>
            </table>
            
            <hr>
            <h6>Resultados del Checklist</h6>
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th style="width: 70%;">칈tem</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // 游뚿 CORRECCI칍N 2 y 3: Iterar sobre la lista de objetos 'checklist_details_list' y usar los nuevos estados
        checklist_details_list.forEach(detail => {
            const item = detail.item;
            const status = detail.estado; // Valores de la BD: 'Buen Estado', 'Mal Estado', 'N/A'
            let badge = '';

            if (status === 'Buen Estado') {
                badge = '<span class="badge bg-success">Buen Estado</span>';
            } else if (status === 'Mal Estado') {
                badge = '<span class="badge bg-danger">Mal Estado</span>';
            } else {
                badge = '<span class="badge bg-secondary">N/A</span>';
            }
            
            html += `
                <tr>
                    <td>${item}</td>
                    <td>${badge}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        // Actualizar el t칤tulo y cuerpo del modal
        document.getElementById('detailModalLabel').innerText = `Detalle de Reporte #${report.id}`;
        document.getElementById('detail-body').innerHTML = html;

        // Mostrar el modal
        var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        detailModal.show();
    }
</script>
{% endblock %}
